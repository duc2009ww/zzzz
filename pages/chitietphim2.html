<script src="movies.js"></script>
<script>
  const params = new URLSearchParams(window.location.search);
  const movieId = parseInt(params.get("id"));
  const movie = movies.find(m => m.id === movieId);

  const movieDetail = document.getElementById("movie-detail");
  const trailerDiv = document.getElementById("trailer");

  if (!movie) {
    movieDetail.innerHTML = `<h4 class="text-danger">Kh√¥ng t√¨m th·∫•y phim!</h4>`;
  } else {
    document.title = `Chi ti·∫øt phim - ${movie.title}`;
    movieDetail.innerHTML = `
      <div class="col-md-4 text-center">
        <img src="${movie.image}" alt="${movie.title}" class="movie-poster shadow">
      </div>
      <div class="col-md-8">
        <div class="movie-info">
          <h2>${movie.title}</h2>
          <ul class="list-unstyled">
            <li><strong>NƒÉm:</strong> ${movie.year}</li>
            <li><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genre}</li>
            <li><strong>ƒê·∫°o di·ªÖn:</strong> ${movie.director}</li>
            <li><strong>Di·ªÖn vi√™n:</strong> ${movie.cast}</li>
            <li><strong>Th·ªùi l∆∞·ª£ng:</strong> ${movie.duration}</li>
          </ul>
          <div class="rating mb-3" id="starRating">
            <strong>ƒê√°nh gi√° c·ªßa b·∫°n:</strong><br>
            <i class="bi bi-star inactive" data-rate="1"></i>
            <i class="bi bi-star inactive" data-rate="2"></i>
            <i class="bi bi-star inactive" data-rate="3"></i>
            <i class="bi bi-star inactive" data-rate="4"></i>
            <i class="bi bi-star inactive" data-rate="5"></i>
            <span id="ratingValue" class="ms-2">(ch∆∞a c√≥)</span>
          </div>
          <p>${movie.description}</p>
        </div>
      </div>
    `;

    // VIDEO PLAYER
    trailerDiv.innerHTML = `
      <div class="col-12 mt-4">
        <h3>üéû Xem phim</h3>
        <div class="ratio ratio-16x9 mb-3">
          <iframe id="player" src="${movie.trailer}" allowfullscreen></iframe>
        </div>
      </div>
    `;

    // DANH S√ÅCH T·∫¨P ƒê√É RA
    if (movie.episodes && movie.episodes.length > 0) {
      const epContainer = document.createElement("div");
      epContainer.className = "col-12 mt-3";
      epContainer.innerHTML = `<h4>üì∫ Danh s√°ch t·∫≠p (ƒê√£ ra: ${movie.releasedEpisodes}/${movie.episodes.length})</h4>`;
      const epList = document.createElement("div");
      epList.className = "d-flex flex-wrap gap-2";

      const released = movie.episodes.slice(0, movie.releasedEpisodes);
      const currentEpKey = `currentEp_${movieId}`;
      const savedEp = parseInt(localStorage.getItem(currentEpKey)) || 1;

      released.forEach(ep => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-dark btn-sm ep-btn";
        btn.textContent = "T·∫≠p " + ep.ep;
        if (ep.ep === savedEp) btn.classList.add("active");
        btn.addEventListener("click", () => {
          document.getElementById("player").src = ep.url;
          document.querySelectorAll(".ep-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          localStorage.setItem(currentEpKey, ep.ep);
        });
        epList.appendChild(btn);
      });

      epContainer.appendChild(epList);
      trailerDiv.appendChild(epContainer);

      // T·ª± ƒë·ªông m·ªü t·∫≠p ƒëang l∆∞u ho·∫∑c t·∫≠p m·ªõi nh·∫•t
      const currentEp = released.find(e => e.ep === savedEp) || released[released.length - 1];
      if (currentEp) document.getElementById("player").src = currentEp.url;
    }
  }

  // ==== ƒê√ÅNH GI√Å SAO ====
  const stars = document.querySelectorAll("#starRating i");
  const ratingValue = document.getElementById("ratingValue");
  const ratingKey = `rating_${movieId}`;
  let currentRating = localStorage.getItem(ratingKey) || 0;
  highlightStars(currentRating);

  stars.forEach(star => {
    star.addEventListener("click", () => {
      const rate = parseInt(star.getAttribute("data-rate"));
      localStorage.setItem(ratingKey, rate);
      highlightStars(rate);
    });
  });

  function highlightStars(rating) {
    stars.forEach(s => {
      s.classList.remove("bi-star-fill");
      s.classList.add("inactive");
    });
    for (let i = 0; i < rating; i++) {
      stars[i].classList.add("bi-star-fill");
      stars[i].classList.remove("inactive");
    }
    ratingValue.textContent = rating > 0 ? `(${rating}/5 sao)` : "(ch∆∞a c√≥)";
  }

  // ==== B√åNH LU·∫¨N ====
  const form = document.getElementById('commentForm');
  const text = document.getElementById('commentText');
  const list = document.getElementById('comments');
  const commentKey = `comments_${movieId}`;
  const savedComments = JSON.parse(localStorage.getItem(commentKey)) || [];

  savedComments.forEach(c => addCommentToList(c));

  form.addEventListener('submit', e => {
    e.preventDefault();
    const comment = text.value.trim();
    if (comment) {
      addCommentToList(comment);
      savedComments.unshift(comment);
      localStorage.setItem(commentKey, JSON.stringify(savedComments));
      text.value = '';
    }
  });

  function addCommentToList(comment) {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = comment;
    list.prepend(li);
  }
</script>
